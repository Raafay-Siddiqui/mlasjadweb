{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}

{% block body_class %}bg-dome{% endblock %}

{% block content %}
<link rel="preload" href="{{ url_for('static', filename='css/admin.css') }}" as="style">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

<div class="admin-container">
  <div class="admin-stack">
    <header>
      <h2 class="admin-page-title">ðŸ‘¤ Manage Users</h2>
      <p class="admin-intro">Update roles, adjust course access, and keep your roster organised.</p>
    </header>

    <div class="admin-btn-row">
      <a href="{{ url_for('admin_dashboard') }}" class="admin-btn admin-btn--ghost admin-btn--small">â¬… Back to Admin Dashboard</a>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="admin-alert">
          <ul>
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endwith %}

    <div class="admin-card">
      <div class="admin-table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Full Name</th>
              <th>Role</th>
              <th>Courses</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.full_name or "-" }}</td>
              <td>
                <form action="{{ url_for('update_role', user_id=user.id) }}" method="POST" class="inline-form">
                  <input type="hidden" name="redirect" value="{{ request.full_path }}">
                  <select name="role">
                    <option value="user" {% if user.role=="user" %}selected{% endif %}>Free</option>
                    <option value="paid" {% if user.role=="paid" %}selected{% endif %}>Paid</option>
                    <option value="admin" {% if user.role=="admin" %}selected{% endif %}>Admin</option>
                  </select>
                  <button type="submit" class="admin-btn admin-btn--ghost">Update</button>
                </form>
              </td>
              <td>
                <form action="{{ url_for('update_courses', user_id=user.id) }}" method="POST">
                  <input type="hidden" name="redirect" value="{{ request.full_path }}">
                  <div class="admin-checkboxes">
                    {% for course in courses %}
                      {% set has_legacy_access = course.name in user.get_courses() %}
                      {% set has_paid_access = course.user_has_access(user.id) %}
                      <label>
                        <input type="checkbox" name="courses" value="{{ course.name }}" {% if has_legacy_access or has_paid_access %}checked{% endif %}>
                        {{ course.name|capitalize }} (Year {{ course.year }})
                        {% if has_paid_access %}
                          <span style="color: #48e1a0; font-size: 0.85em;">ðŸ’³ Purchased</span>
                        {% endif %}
                      </label>
                    {% endfor %}
                  </div>
                  <div class="admin-btn-row">
                    <button type="submit" class="admin-btn admin-btn--ghost">Save</button>
                  </div>
                </form>
              </td>
              <td>
                <div class="admin-btn-row admin-btn-row--tight">
                  <a href="{{ url_for('admin_user_tracking', user_id=user.id) }}" class="admin-btn admin-btn--ghost admin-btn--small">View Details</a>
                  <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" onsubmit="return confirm('Delete user {{ user.username }}?');">
                    <input type="hidden" name="redirect" value="{{ request.full_path }}">
                    <button type="submit" class="admin-btn admin-btn--danger admin-btn--small">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7">No users found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
