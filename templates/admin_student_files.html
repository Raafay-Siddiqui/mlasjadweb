{% extends "base.html" %}
{% block title %}Student Hub Files{% endblock %}

{% block body_class %}bg-dome{% endblock %}

{% block content %}
<link rel="preload" href="{{ url_for('static', filename='css/admin.css') }}" as="style">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

<div class="admin-container">
  <div class="admin-stack">
    <header>
      <h2 class="admin-page-title">üìÅ Student Hub Files</h2>
      <p class="admin-intro">Review uploads from paid students, leave feedback, and manage submissions.</p>
    </header>

    <div class="admin-btn-row">
      <a href="{{ url_for('admin_dashboard') }}" class="admin-btn admin-btn--ghost admin-btn--small">‚¨Ö Back to Admin Dashboard</a>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="admin-alert">
          <ul>
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endwith %}

    <div class="admin-card">
      <form method="get" action="{{ url_for('admin_student_files') }}" class="admin-form" style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:18px;">
        <label style="flex:1 1 220px;">
          <span>Search name or email</span>
          <input type="search" name="search" placeholder="e.g. Maryam or maryam@email.com" value="{{ selected_search or '' }}">
        </label>
        <label style="flex:1 1 220px;">
          <span>Filter by student</span>
          <select name="student_id">
            <option value="">All students</option>
            {% for student in students_with_files %}
              <option value="{{ student.id }}" {% if selected_student_id == student.id %}selected{% endif %}>{{ student.full_name or student.username }}</option>
            {% endfor %}
          </select>
        </label>
        <label style="flex:1 1 220px;">
          <span>Filter by course</span>
          <select name="course_name">
            <option value="">All courses</option>
            {% for course_name in course_names %}
              <option value="{{ course_name }}" {% if selected_course_name == course_name %}selected{% endif %}>{{ course_name|capitalize }}</option>
            {% endfor %}
          </select>
        </label>
        <div style="display:flex; gap:10px; flex:0 0 auto;">
          <button type="submit" class="admin-btn admin-btn--primary">Apply</button>
          <a href="{{ url_for('admin_student_files') }}" class="admin-btn admin-btn--ghost">Clear</a>
        </div>
      </form>

      <div class="admin-table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Uploaded</th>
              <th>Student</th>
              <th>Courses</th>
              <th>File</th>
              <th>Size</th>
              <th>Feedback</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if student_hub_files %}
              {% for item in student_hub_files %}
              <tr>
                <td>{{ item.uploaded_at.strftime('%d %b %Y, %H:%M') }}</td>
                <td>{{ item.user.full_name or item.user.username }}</td>
                <td>{{ item.user.get_courses()|join(', ') }}</td>
                <td><a href="{{ url_for('student_hub_download', file_id=item.id) }}">{{ item.original_name }}</a></td>
                <td>{{ '%.1f' % (item.file_size / (1024 * 1024)) }} MB</td>
                <td>
                  <form action="{{ url_for('admin_student_hub_feedback', file_id=item.id) }}" method="POST" style="display:flex; flex-direction:column; gap:8px;">
                    <input type="hidden" name="redirect" value="{{ request.full_path or url_for('admin_student_files') }}">
                    <label style="display:flex; flex-direction:column; gap:6px;">
                      <span style="font-size:0.85rem; color:var(--muted);">Grade (0-100 or A-F)</span>
                      <input type="text" name="feedback_grade" value="{{ item.feedback_grade or '' }}" placeholder="e.g. 92 or A" style="width:100%;">
                    </label>
                    <label style="display:flex; flex-direction:column; gap:6px;">
                      <span style="font-size:0.85rem; color:var(--muted);">Feedback</span>
                      <textarea name="feedback_text" rows="3" placeholder="Add short feedback" style="width:100%; resize:vertical;">{{ item.feedback_text or '' }}</textarea>
                    </label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                      <button type="submit" name="action" value="save" class="admin-btn admin-btn--primary">Save</button>
                      {% if item.feedback_text or item.feedback_grade %}
                        <button type="submit" name="action" value="clear" class="admin-btn admin-btn--ghost">Clear</button>
                      {% endif %}
                    </div>
                  </form>
                </td>
                <td>
                  <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <a href="{{ url_for('student_hub_download', file_id=item.id) }}" class="admin-btn admin-btn--ghost">Download</a>
                    <form action="{{ url_for('admin_student_hub_delete', file_id=item.id) }}" method="POST" onsubmit="return confirm('Delete {{ item.original_name }}?');">
                      <input type="hidden" name="redirect" value="{{ request.full_path or url_for('admin_student_files') }}">
                      <button type="submit" class="admin-btn admin-btn--danger">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7">No Student Hub files uploaded yet.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
